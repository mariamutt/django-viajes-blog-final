{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}Chat con {{ other_user.username }}{% endblock %}

{% block content %}

<div class="container mx-auto p-4 sm:p-6 lg:p-8 flex flex-col h-full max-w-3xl">

<!-- Encabezado de la Conversación -->
<div class="bg-white shadow-lg rounded-t-xl p-4 sm:p-6 mb-4 sticky top-0 z-10 border-b border-gray-200">
    <h1 class="text-2xl font-bold text-gray-800">
        <a href="{% url 'inbox:inbox' %}" class="text-indigo-600 hover:text-indigo-800 mr-3">
            <i class="fa-solid fa-arrow-left"></i>
        </a>
        Conversación con {{ other_user.get_full_name|default:other_user.username }}
    </h1>
    <p class="text-sm text-gray-500 mt-1">
        <a href="{% url 'profiles:profile' username=other_user.username %}" class="hover:underline text-indigo-500">
            Ver Perfil
        </a>
    </p>
</div>

<!-- Contenedor de Mensajes (Scrollable) -->
<div id="message-container" class="flex-grow overflow-y-auto space-y-4 p-4 bg-gray-50 rounded-xl mb-4 shadow-inner">
    {% for message in messages_list %}
        {% if message.sender == request.user %}
            <!-- Mensaje Enviado (Derecha) -->
            <div class="flex justify-end">
                <div class="max-w-xs sm:max-w-md bg-indigo-600 text-white p-3 rounded-l-xl rounded-br-xl shadow-md">
                    <p>{{ message.content }}</p>
                    <span class="block text-right text-xs mt-1 text-indigo-200">
                        {{ message.timestamp|naturaltime }}
                    </span>
                </div>
            </div>
        {% else %}
            <!-- Mensaje Recibido (Izquierda) -->
            <div class="flex justify-start">
                <div class="max-w-xs sm:max-w-md bg-white text-gray-800 p-3 rounded-r-xl rounded-bl-xl shadow-md border border-gray-200">
                    <p>{{ message.content }}</p>
                    <span class="block text-left text-xs mt-1 text-gray-400">
                        {{ message.timestamp|naturaltime }}
                    </span>
                </div>
            </div>
        {% endif %}
    {% empty %}
        <div class="text-center text-gray-500 p-10">
            <p>¡Dile hola a {{ other_user.username }}! Escribe el primer mensaje para iniciar la conversación.</p>
        </div>
    {% endfor %}
</div>

<!-- Formulario de Respuesta (Fijo en la parte inferior) -->
<div class="bg-white p-4 rounded-b-xl shadow-2xl border-t border-gray-200">
    <form method="post" action=".">
        {% csrf_token %}
        <div class="flex items-center space-x-3">
            <!-- El campo de contenido del formulario -->
            <div class="flex-grow">
                {{ form.content }}
            </div>
            <!-- Botón de Envío -->
            <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-full shadow-lg transition duration-150 ease-in-out">
                <i class="fa-solid fa-paper-plane mr-1"></i> Enviar
            </button>
        </div>
    </form>
    {% comment %} Mostrar errores del formulario si existen {% endcomment %}
    {% if form.content.errors %}
        <p class="text-red-500 text-sm mt-1">{{ form.content.errors|join:", " }}</p>
    {% endif %}
</div>


</div>

<script>
// Script para hacer scroll automáticamente al final de la conversación
document.addEventListener('DOMContentLoaded', function() {
const container = document.getElementById('message-container');
if (container) {
container.scrollTop = container.scrollHeight;
}
});
</script>

{% endblock %}