{% extends 'base.html' %} 

{% block title %}Bandeja de Entrada{% endblock %}

{% block content %}
<div class="container mx-auto mt-8 p-4 max-w-4xl">
    <h1 class="text-3xl font-bold mb-6 border-b pb-2 text-gray-800">Tu Bandeja de Entrada</h1>
    
    {% if messages %}
        <div class="mb-4">
            {% for message in messages %}
                <div class="p-4 rounded-lg 
                    {% if message.tags == 'error' or message.tags == 'warning' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-100 text-blue-700{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}


    <div class="mb-6">
        <a href="{% url 'inbox:new_thread' %}" 
            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-300">
            + Nuevo Mensaje
        </a>
    </div>

    <div class="space-y-4">
        {% if conversations %}
            {% for last_message in conversations %}
            
                {% comment %} 
                    Identificamos al otro participante para poder enlazar a la conversación.
                {% endcomment %}
                {% if last_message.sender == request.user %}
                    {% with other_user=last_message.receiver %}
                        {% url 'inbox:detail' other_user.id as detail_url %}
                    {% endwith %}
                {% else %}
                    {% with other_user=last_message.sender %}
                        {% url 'inbox:detail' other_user.id as detail_url %}
                    {% endwith %}
                {% endif %}
            
                <a href="{{ detail_url }}" class="block hover:bg-gray-50 transition duration-150 rounded-xl">
                    <div class="bg-white p-4 rounded-xl shadow-sm border 
                        {% if not last_message.is_read and last_message.receiver == request.user %}
                            border-indigo-500 bg-indigo-50 font-semibold
                        {% else %}
                            border-gray-200
                        {% endif %}">
                        
                        <div class="flex justify-between items-start">
                            <div class="flex items-center space-x-3">
                                <span class="text-sm text-gray-600">Conversación con: 
                                    <span class="font-extrabold text-gray-900 text-lg">{{ other_user.username }}</span>
                                </span>
                            </div>
                            <span class="text-xs text-gray-500 mt-1">
                                {{ last_message.timestamp|date:"d M Y, H:i" }}
                            </span>
                        </div>
                        
                        <p class="mt-2 text-gray-600 text-sm italic truncate">
                            {% if last_message.sender == request.user %}
                                <span class="font-medium text-black">Tú:</span>
                            {% elif not last_message.is_read and last_message.receiver == request.user %}
                                <span class="font-extrabold text-indigo-700">NUEVO:</span>
                            {% else %}
                                <span class="font-medium text-black">{{ other_user.username }}:</span>
                            {% endif %}
                            
                            {{ last_message.content|truncatechars:80 }}
                        </p>
                        
                    </div>
                </a>
            {% endfor %}
        {% else %}
            <div class="text-center p-10 bg-gray-100 rounded-xl border border-dashed">
                <p class="text-xl text-gray-600">¡Tu bandeja de entrada está vacía!</p>
                <p class="text-gray-500 mt-2">Usa el botón "Nuevo Mensaje" para comenzar una conversación.</p>
            </div>
        {% endif %}
    </div>

</div>
{% endblock %}